<!DOCTYPE html>
<html>

<head>
    <style>
        #a {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <canvas id="a"></canvas>
    <script>
        var xhttp = new XMLHttpRequest(),
            b = document.getElementById("a"),
            c = b.getContext("2d");
        b.width = window.innerWidth;
        b.height = window.innerHeight;
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                //console.log(this.responseText);
                var data = this.responseText.split(",").map(function (val) {
                    return Number(val);
                });
                var num = c.createImageData(800, 600),
                    numData = num.data,
                    formatted = [];
                class Pixel {
                    constructor(r, g, b) {
                        this.r = r;
                        this.g = g;
                        this.b = b;
                        this.col = [r, g, b];
                    }
                    set(name, val) {
                        this[name] = val;
                    }
                }
                // [0, 0, 80] is the sea; nobody lives in there.
                // Elsewise the color decides the population.

                Array.prototype.add = function () {
                    var add = 0;
                    for (var i = 0; i < this.length; i++) {
                        add += this[i];
                    }
                    return add;
                }
                var ii = 0,
                    newFormat = [];
                for (var i = 0; i < data.length; i += 4) {
                    formatted.push(new Pixel(data[i], data[i + 1], data[i + 2]));
                }
                for (var i = 0; i < formatted.length; i++) {
                    if (formatted[i].col.join("") == "00255") {
                        // console.log("upp");
                        formatted[i].set("pop", 0);
                        formatted[i].set("peopleSick", 0);
                    }
                    else {
                        // Okay, there are 3.797 million miles in the US, and 277307 pixel-pieces of US.
                        // That means each pixel represents 13.69 miles.
                        var miPerPixel = 13.69;
                        formatted[i].set("pop", ((formatted[i].col).add() * (1000 * miPerPixel)) + (250 * miPerPixel));
                        formatted[i].set("peopleSick", Math.sin(i / 2)); // The % of people sick; must be normalized
                    }
                }
                function normalize(prop) {
                    var biggestVal = formatted.slice().sort(function (a, b) {
                        return b[prop] - a[prop];
                    })[0][prop];
                    for (var i = 0; i < formatted.length; i++) {
                        //console.log(i + 101000, (formatted[i + 101000].pop / biggestVal) * 255);
                        formatted[i][prop] = (formatted[i][prop] / biggestVal) * 255;
                        //console.log(i + 101000, formatted[i + 101000].pop);
                    }
                }
                normalize("pop");
                normalize("peopleSick");
                for (var i = 0; i < numData.length; i += 4) {
                    if (formatted[ii].pop == 0) {
                        // SEA
                        numData[i] = 0; /*red*/
                        numData[i + 1] = 0; /*green*/
                        numData[i + 2] = 100; /*blue*/
                    }
                    else {
                        numData[i] = formatted[ii].peopleSick;/*red*/
                        numData[i + 1] = formatted[ii].peopleSick; /*green*/
                        numData[i + 2] = formatted[ii].peopleSick; /*blue*/
                    }
                    numData[i + 3] = 255;
                    ii++;
                }
                //c.scale(num.width / b.width, num.height / b.height);
                Array.prototype.clean = function (wid, hei) {
                    var ans1 = [],
                        ans2 = [];
                    for (var i = 0; i < this.length; i++) {
                        //ans2.push([this[i], i + 1, wid, (i + 1) % wid]);
                        //console.log(ans1);
                        ans1.push(this[i]);
                        if ((i + 1) % wid == 0) {
                            ans2.push(ans1.slice());
                            ans1.length = 0;
                        }
                    }
                    return ans2;
                }
                Array.prototype.unClean = function () {
                    var ans = [];
                    for (var i = 0; i < this.length; i++) {
                        ans = ans.concat(this[i]);
                    }
                    return ans;
                }
                var use = formatted.clean(800, 600);
                function animate() {
                    window.requestAnimationFrame(animate);
                    // Now, we manipulate use, unClean it, and set it to formatted.
                    // Let's say the chance of not spreading = 0.6 if someone gets close.
                    // So if two people near you are sick, the chance of not spreading is 0.36.
                    for (var i = 0; i < use.length; i++) {
                        for (var ii = 0; ii < use[i].length; ii++) {
                            // Going through each; now we need to find the guys next to it, add them up, and 0.6^that
                            var chance = 0;
                            for (var z = -1; z < 1; z++) {
                                for (var zz = -1; zz < 1; zz++) {
                                    if (use[i + z]) {
                                        if (use[i + z][ii + zz]) {
                                            chance += use[i + z][ii + zz].peopleSick;
                                        }
                                    }
                                }
                            }
                            use[i][ii].peopleSick = Math.pow(0.6, chance);
                        }
                    }
                    // Now un-clean this.
                    c.putImageData(num, 0, 0);
                    //console.log("Yo");
                }
                animate();
                // var usaCount = 0;
                // for (var i = 0; i < formatted.length; i++) {
                //     if (formatted[i].col.join("") !== "00255") {
                //         usaCount++;
                //     }
                // }
                // console.log(usaCount); // Number of pixels that are USA.
                // Okay, 277307 pixels are US. 
            }
        }
        xhttp.open("GET", "data");
        xhttp.send();
    </script>
</body>

</html>